<!--Item Modal -->

<div class="modal fade" id="itemModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="itemModalTitle"><!--itemName --></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body container">
            <img id="itemModalCover" style="width: 100%;"><!-- coverFileName -->
            <div class="row" style="margin-left: 0rem;">
                <h2 id="itemModalPrice" class="align-self-center" style="margin-top: 1rem;">￥</h2><!-- itemPrice -->
            
                <div id="itemModalBandageArea" class="align-self-center" style="margin-top: 0.9rem; margin-left: 1rem;">
                    <span id="itemModalBandagePost" class=" badge badge-primary">邮寄</span>
                    <span id="itemModalBandageFace" class=" badge badge-success">当面交易</span>
                    <span id="itemModalBandageNoNeed" class=" badge badge-success">无需运送</span>
                </div>
            </div>
            
            <hr>
            <h5>简介</h5>
            <p id="itemModalDescription"></p>
            <h5>新旧描述</h5>
            <p id="itemModalOldNewRate"></p>
            <small id="itemModalRemarks"></small>
            <hr>
            <h5>联系方式</h5>
            <div>
                <p id="unloginReminder"><a href="/login">登录</a>后方可获取卖家联系方式</p>
                <p id="itemModalUserQQ" style="margin: 0.5rem; margin-left: 0; display: none;">QQ</p>
                <p id="itemModalUserWeChat" style="margin: 0.5rem; margin-left: 0; display: none;">微信</p>
            </div>
            

            


        </div>
        <div class="modal-footer">
            <a  id="launchQQ" type="button" href="" class="btn btn-primary" target="_blank" style="display: none;">发起QQ会话</a>
            <div id="copyWeChatID" class="btn btn-success" data-clipboard-text='' style="display: none;" >复制微信号</div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
        </div>
        </div>
    </div>
</div>

<script>
    getItemInfo = function(itemID){
        $.ajax({
            type: 'GET',
            url: '/getItemInfo',
            data: {'itemID': itemID },
            success: (itemJson) => {
                $(".badge").css("display","");
                $(".badge").css("font-size","0.9rem");
                $("#itemModalCover").attr('src','upload/' + itemJson.coverFileName);
                $("#itemModalTitle").html(itemJson.itemName);
                $("#itemModalPrice").html("￥" + itemJson.itemPrice);
                if(!itemJson.deliverByPost) $("#itemModalBandagePost").css("display", 'none');
                if(!itemJson.deliverByFace) $("#itemModalBandageFace").css("display", 'none');
                if(!itemJson.deliverNoNeed) $("#itemModalBandageNoNeed").css("display", 'none');
                $("#itemModalDescription").html(itemJson.itemDescription);
                $("#itemModalOldNewRate").html(itemJson.itemOldNewRate);
                $("#itemModalRemarks").html("备注：" + itemJson.remarks);
                $.ajax({
                    type: 'GET',
                    url: '/getItemUserInfo',
                    headers:{'Authorization': `Bearer ${token}`},
                    data: {'userName': itemJson.itemUserName},
                    success: (res) =>{
                        if(res.toString().startsWith('ERROR')){
                            console.log("可能未登录, 无法获取卖家信息")
                            console.error(res);
                        }else{
                            console.log("Parsing response from /getItemUserInfo")
                            let user = res;
                            let userQQ = user.UserQQ;
                            let userWeChat = user.UserWeChat;
                            // 检测QQ是否存在,并显示
                            
                            // 隐藏未登录提示
                            $("#unloginReminder").css("display", "none")

                            if(userQQ != "" && userQQ != "NotSet"){
                                // 修改链接
                                $("#launchQQ").attr("href", `http://wpa.qq.com/msgrd?v=3&uin=${userQQ}&site=qq&menu=yes`)
                                // 取消隐藏
                                $("#launchQQ").css("display", "")
                                // 修改文本
                                $("#itemModalUserQQ").html(`QQ: ${userQQ}`);
                                // 取消隐藏
                                $("#itemModalUserQQ").css("display", "");

                            }
                            if(userWeChat != "" && userWeChat != "NotSet"){
                                console.log("get WeChat and about to display")
                                // 修改剪切板插件属性                                    
                                $("#copyWeChatID").attr("data-clipboard-text", `${userWeChat}`)
                                // 取消隐藏
                                $("#copyWeChatID").css("display", "")
                                //  修改文本
                                $("#itemModalUserWeChat").html(`微信: ${userWeChat}`);
                                // 取消隐藏
                                $("#itemModalUserWeChat").css("display", "");



                            }

                        
                            
                        }
                    }
                })
            }
        })
    }
    
</script>